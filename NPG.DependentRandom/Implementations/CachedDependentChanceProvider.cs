using System;
using System.Collections.Generic;
using NPG.DependentRandom.Infrastructure;

namespace NPG.DependentRandom.Implementations
{
	public class CachedDependentChanceProvider : IDependentChanceProvider
	{
		private const float CacheStep = 0.5f;
		
		public float GetDependentChance(float chance)
		{
			chance = Math.Max(chance, 0f);
			chance = Math.Min(chance, 1f);
			var key = GetNearestValue(chance);
			return !_deltaDataMap.TryGetValue(key, out var result) ? 0f : result;
		}
		
		private static float GetNearestValue(float val)
		{
			return RoundToStep(val, CacheStep);
		}

		private static float RoundToStep(float val, float step)
		{
			return (int)(Math.Round(val * 100f / step) * step);
		}
		
		private static readonly Dictionary<float, float> _deltaDataMap = new Dictionary<float, float>
		{
			{ 0f, 0f },
			{ 0.5f, 0.00003f },
			{ 1f, 0.00014f },
			{ 1.5f, 0.00031f },
			{ 2f, 0.0005599999f },
			{ 2.5f, 0.0009000005f },
			{ 3f, 0.001289999f },
			{ 3.5f, 0.001749997f },
			{ 4f, 0.00234f },
			{ 4.5f, 0.002900004f },
			{ 5f, 0.00365001f },
			{ 5.5f, 0.004390015f },
			{ 6f, 0.005140021f },
			{ 6.5f, 0.006130029f },
			{ 7f, 0.007080036f },
			{ 7.5f, 0.007950036f },
			{ 8f, 0.009229986f },
			{ 8.5f, 0.01039994f },
			{ 9f, 0.0114599f },
			{ 9.5f, 0.01299984f },
			{ 10f, 0.01422979f },
			{ 10.5f, 0.01563974f },
			{ 11f, 0.01727983f },
			{ 11.5f, 0.01888991f },
			{ 12f, 0.02037999f },
			{ 12.5f, 0.02219009f },
			{ 13f, 0.02403019f },
			{ 13.5f, 0.02570028f },
			{ 14f, 0.02725037f },
			{ 14.5f, 0.02959049f },
			{ 15f, 0.03147055f },
			{ 15.5f, 0.03330031f },
			{ 16f, 0.03563f },
			{ 16.5f, 0.03780971f },
			{ 17f, 0.03984945f },
			{ 17.5f, 0.04231912f },
			{ 18f, 0.04456882f },
			{ 18.5f, 0.04723847f },
			{ 19f, 0.04952817f },
			{ 19.5f, 0.05164789f },
			{ 20f, 0.05418755f },
			{ 20.5f, 0.05714716f },
			{ 21f, 0.05993679f },
			{ 21.5f, 0.06222649f },
			{ 22f, 0.06460617f },
			{ 22.5f, 0.06828569f },
			{ 23f, 0.07089534f },
			{ 23.5f, 0.07432489f },
			{ 24f, 0.0772645f },
			{ 24.5f, 0.07985416f },
			{ 25f, 0.08325371f },
			{ 25.5f, 0.08653328f },
			{ 26f, 0.08957288f },
			{ 26.5f, 0.09328239f },
			{ 27f, 0.09633198f },
			{ 27.5f, 0.09970154f },
			{ 28f, 0.1029011f },
			{ 28.5f, 0.1064306f },
			{ 29f, 0.1104001f },
			{ 29.5f, 0.1135997f },
			{ 30f, 0.1169393f },
			{ 30.5f, 0.1205688f },
			{ 31f, 0.1246882f },
			{ 31.5f, 0.1283378f },
			{ 32f, 0.1317773f },
			{ 32.5f, 0.1362467f },
			{ 33f, 0.1397562f },
			{ 33.5f, 0.1436957f },
			{ 34f, 0.1474852f },
			{ 34.5f, 0.1521146f },
			{ 35f, 0.1557241f },
			{ 35.5f, 0.1595536f },
			{ 36f, 0.1637531f },
			{ 36.5f, 0.1682325f },
			{ 37f, 0.1730019f },
			{ 37.5f, 0.1767414f },
			{ 38f, 0.1809308f },
			{ 38.5f, 0.1853102f },
			{ 39f, 0.1895797f },
			{ 39.5f, 0.1951189f },
			{ 40f, 0.1991684f },
			{ 40.5f, 0.2035478f },
			{ 41f, 0.2076373f },
			{ 41.5f, 0.2134765f },
			{ 42f, 0.2181059f },
			{ 42.5f, 0.2225453f },
			{ 43f, 0.2275846f },
			{ 43.5f, 0.232204f },
			{ 44f, 0.2369934f },
			{ 44.5f, 0.2418728f },
			{ 45f, 0.2465421f },
			{ 45.5f, 0.2512634f },
			{ 46f, 0.2557495f },
			{ 46.5f, 0.2625587f },
			{ 47f, 0.2673352f },
			{ 47.5f, 0.2731531f },
			{ 48f, 0.2772887f },
			{ 48.5f, 0.2832268f },
			{ 49f, 0.288584f },
			{ 49.5f, 0.2942517f },
			{ 50f, 0.2990682f },
			{ 50.5f, 0.304806f },
			{ 51f, 0.3093522f },
			{ 51.5f, 0.3142588f },
			{ 52f, 0.3201368f },
			{ 52.5f, 0.3243425f },
			{ 53f, 0.330571f },
			{ 53.5f, 0.3367193f },
			{ 54f, 0.3434184f },
			{ 54.5f, 0.3491462f },
			{ 55f, 0.3568766f },
			{ 55.5f, 0.3622639f },
			{ 56f, 0.3695839f },
			{ 56.5f, 0.3759725f },
			{ 57f, 0.3826216f },
			{ 57.5f, 0.3880689f },
			{ 58f, 0.394758f },
			{ 58.5f, 0.4007962f },
			{ 59f, 0.4066241f },
			{ 59.5f, 0.4135235f },
			{ 60f, 0.4189709f },
			{ 60.5f, 0.4254897f },
			{ 61f, 0.4314978f },
			{ 61.5f, 0.4371655f },
			{ 62f, 0.4429934f },
			{ 62.5f, 0.4488313f },
			{ 63f, 0.4548195f },
			{ 63.5f, 0.4603069f },
			{ 64f, 0.4664853f },
			{ 64.5f, 0.4723833f },
			{ 65f, 0.4779609f },
			{ 65.5f, 0.4838288f },
			{ 66f, 0.4890359f },
			{ 66.5f, 0.4955747f },
			{ 67f, 0.500211f },
			{ 67.5f, 0.5104048f },
			{ 68f, 0.5236528f },
			{ 68.5f, 0.5334361f },
			{ 69f, 0.5450318f },
			{ 69.5f, 0.5557163f },
			{ 70f, 0.5649388f },
			{ 70.5f, 0.5745018f },
			{ 71f, 0.5844052f },
			{ 71.5f, 0.5956705f },
			{ 72f, 0.6048129f },
			{ 72.5f, 0.6143458f },
			{ 73f, 0.6238687f },
			{ 73.5f, 0.6332214f },
			{ 74f, 0.6429245f },
			{ 74.5f, 0.648402f },
			{ 75f, 0.6611092f },
			{ 75.5f, 0.66908f },
			{ 76f, 0.6797044f },
			{ 76.5f, 0.6884363f },
			{ 77f, 0.696347f },
			{ 77.5f, 0.7036068f },
			{ 78f, 0.7129695f },
			{ 78.5f, 0.721441f },
			{ 79f, 0.7286508f },
			{ 79.5f, 0.7368219f },
			{ 80f, 0.7452133f },
			{ 80.5f, 0.752423f },
			{ 81f, 0.7591622f },
			{ 81.5f, 0.7680843f },
			{ 82f, 0.7751539f },
			{ 82.5f, 0.7829645f },
			{ 83f, 0.7889326f },
			{ 83.5f, 0.7983654f },
			{ 84f, 0.804764f },
			{ 84.5f, 0.8130953f },
			{ 85f, 0.8192837f },
			{ 85.5f, 0.8267138f },
			{ 86f, 0.8324816f },
			{ 86.5f, 0.8393109f },
			{ 87f, 0.8465908f },
			{ 87.5f, 0.8527391f },
			{ 88f, 0.8599088f },
			{ 88.5f, 0.865977f },
			{ 89f, 0.8728964f },
			{ 89.5f, 0.8781235f },
			{ 90f, 0.8855937f },
			{ 90.5f, 0.8916318f },
			{ 91f, 0.8975899f },
			{ 91.5f, 0.9043291f },
			{ 92f, 0.9100368f },
			{ 92.5f, 0.9157746f },
			{ 93f, 0.9209716f },
			{ 93.5f, 0.9276206f },
			{ 94f, 0.9326475f },
			{ 94.5f, 0.938936f },
			{ 95f, 0.9445837f },
			{ 95.5f, 0.9504416f },
			{ 96f, 0.9563997f },
			{ 96.5f, 0.9614666f },
			{ 97f, 0.9667237f },
			{ 97.5f, 0.9722211f },
			{ 98f, 0.9776485f },
			{ 98.5f, 0.9829557f },
			{ 99f, 0.9884632f },
			{ 99.5f, 0.9931595f },
			{ 100f, 1f }
		};
	}
}